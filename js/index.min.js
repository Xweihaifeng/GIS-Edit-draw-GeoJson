"use strict";var layerJsonData={},tmpPartJsonData={},popupSaveData={},iconSaveData={},selPopupType=null,currLayerObj=null,layerObj={},currLayerId="",currLayerType="",isClick=!0,sel_type="part",drawObj=null,batchAddFeature=[],batchCenter=[],berthState=!1,zoomRange=[12,13,14,15,16,17,18,19,20,21,22],setCenter=[108.763156,34.258986],pathUrl="http://114.115.183.47:8000/com.cloud.isoft.wxs.service",pathService="/WMSServices/loadStdout?serviceName=gisserver_wms_shape_xietongchuangxin_1",mymap=new iGis.GisMap;mymap.createMap({mapType:iGis.MapType.OPENSTREET_MAP,divId:"iGis",center:setCenter,zoom:15,maxZoom:22,projection:"EPSG:3857",isScaleLine:!0,isMousePosition:!0,isZoomLevel:!0,units:"metric",wrapX:!1});var mymapParam={mapType:iGis.MapType.WMS_MAP,url:pathUrl+pathService,layerParams:{VERSION:"1.3.0",LAYERS:"gisserver"},divId:"iGis",center:setCenter,zoom:15,minZoom:1,maxZoom:22,projection:"EPSG:4326",isScaleLine:!0,isMousePosition:!0,isZoomLevel:!0,units:"metric",wrapX:!1},changeMapService=function(e,t){mymapParam.url=pathUrl+e,mymapParam.center=t,mymap.createMap(mymapParam),mymap.setMapCenter(t)};setCenter=mymap.getMapCenter(),$.ajaxSettings.async=!1;var geojsonObject={type:"FeatureCollection",crs:{type:"name",properties:{name:"EPSG:4326"}},srid:"4326",geoType:"polygon",fieldsInfo:[],features:[{type:"Feature",properties:{id:"publish_all_features"},geometry:{type:"MultiPolygon",name:"all_features",coordinates:[]}}]},shapeObj=new iGis.maptools.DrawShapeFeature({gisMapObj:mymap}),modifyObj=new iGis.maptools.TranslateAndModify({gisMapObj:mymap}),editObj=new iGis.maptools.EditLayer({gisMapObj:mymap}),markerTips=new iGis.maptools.MapTips({gisMapObj:mymap,offset:[-130,-10],element:document.getElementById("marker"),positioning:"bottom-left"}),popup=function(e){var t=!1;e||(e="请正确步骤后操作：<br />（1）、先选择显示图层；<br />（2）、再选择当前操作图层！"),$("#popupBox").html("<div>"+e+"</div>");for(var r=0;r<$("#getGeojson > div").length;r++){var a=$($($("#getGeojson > div")[r]).children("input")[0]).prop("checked"),o=$($($("#getGeojson > div")[r]).children("input")[1]).prop("checked");if(a&&o){$("#popupBox").html(""),t=!1;break}t=!0}return t&&$("#popupBox div").fadeIn("slow").delay(1500).fadeOut("slow"),t};function batchFeature(){if(markerTips.setPosition(popupSaveData.cp),$("#fun5, #fun7").hide(),"point"==currLayerType){var e="<li><input type='text' value='name' class='attr-label'><input type='text' value='newPoint' class='attr-value'></li>";e+="<li><input type='text' value='height' class='attr-label'><input type='text' value='0' class='attr-value'></li>",e+="<li><input type='text' value='icon' class='attr-label'><input type='text' value='' class='attr-value new-point-icon'></li>",e+="<li><input type='text' value='currOperateFeatures' class='attr-label' readonly><input type='text' value='"+currLayerId+"' class='attr-value' readonly></li>",document.getElementById("longitude").innerHTML=e}else if("line"==currLayerType){e="<li><input type='text' value='name' class='attr-label'><input type='text' value='newLine' class='attr-value'></li>";e+="<li><input type='text' value='height' class='attr-label'><input type='text' value='0' class='attr-value'></li>",e+="<li><input type='text' value='currOperateFeatures' class='attr-label' readonly><input type='text' value='"+currLayerId+"' class='attr-value' readonly></li>",document.getElementById("longitude").innerHTML=e}else if("polygon"==currLayerType){e="<li><input type='text' value='name' class='attr-label'><input type='text' value='newPolygon' class='attr-value'></li>";e+="<li><input type='text' value='height' class='attr-label'><input type='text' value='0' class='attr-value'></li>",e+="<li><input type='text' value='currOperateFeatures' class='attr-label' readonly><input type='text' value='"+currLayerId+"' class='attr-value' readonly></li>",e+="<li><input type='text' value='bgType' class='attr-label'><select class='attr-value'><option value='color' selected>color</option><option value='img'>img</option></select></li>",e+="<li class='poly-fillColor'><input type='text' value='fillColor' class='attr-label'><input type='text' value='rgba(122,112,112,.5)' name='showAlpha' id='showAlpha' class='attr-value'></li>",e+="<li class='poly-src'><input type='text' value='src' class='attr-label'><input type='text' value='' class='attr-value new-show-img'></li>",document.getElementById("longitude").innerHTML=e,$(".poly-src").hide(),$("#showAlpha").spectrum({preferredFormat:"rgb",showInput:!0,showAlpha:!0,showPalette:!0,palette:[["red","rgba(0, 0, 0, 0)","rgb(255, 255, 255)"]]})}}function startDrawFeature(r){drawObj.removeDrawFeature(),shapeObj.removeCreate(),isClick=!1,drawObj.addDrawFeature(r,function(e){var t={type:"Feature",id:(new Date).getTime().toString(),properties:{name:"new",height:"",currOperateFeatures:currLayerId},geometry:{type:"Square"==r?"Polygon":r,coordinates:e}};"Point"==r?(batchCenter=e,t.properties.cp=e,t.properties.icon=""):"LineString"==r?(batchCenter=e[0],t.properties.cp=e[0],t.properties.igis_id=t.id,t.properties.fclass="unclassified"):"Polygon"!=r&&"Square"!=r||(batchCenter=e[0][0],t.properties.cp=e[0][0],t.properties.bgType="color",t.properties.fillColor="rgba(0,102,255,0.5)",t.properties.src=""),popupSaveData=t.properties,batchAddFeature.push(t)}),drawObj.setSnapObjLayer(currLayerObj)}function _toConsumableArray(e){if(Array.isArray(e)){for(var t=0,r=Array(e.length);t<e.length;t++)r[t]=e[t];return r}return Array.from(e)}function num(e){return e instanceof Array?Math.max.apply(Math,_toConsumableArray(e.map(function(e){return 1+parseInt(num(e))}))):0}function newFeatures(e){var t={gisMapObj:mymap,serverType:"GEOSERVER",url:layerJsonData[e],layerOptions:{fillColor:"rgb("+Math.floor(256*Math.random())+","+Math.floor(256*Math.random())+","+Math.floor(256*Math.random())+",0.6)",strokeColor:"rgb("+Math.floor(256*Math.random())+","+Math.floor(256*Math.random())+","+Math.floor(256*Math.random())+",1)",selStrokeWidth:1,selFillColor:"#90742b",selStrokeColor:"#008cff",labFillColor:"#00588c",lalFontSize:"11px"},dataProjection:"EPSG:4326"},r=new iGis.layers.DataServerLayer(t);layerObj[e]=r,(currLayerObj=r).addClickEvent(function(e){isClick&&selectPop(e.feature,e.clickCoord)})}function saveLayerType(e){currLayerType=e.type,layerJsonData[e.name]={type:"FeatureCollection",fieldsInfo:[],srid:"4326",geoType:e.type,features:[]},$("#getGeojson").append("<div><input type='checkbox' id="+e.name+" refs='"+e.type+"' name='layerObj'><input type='radio' value = "+e.name+" layerType = "+e.type+" name='layer'><span class='layer-name'>"+e.name+"</span><img src='./img/igis_opt_stop.png' class='deleteFeature' name="+e.name+" type="+e.type+"></div>"),$("#glassLayer,.popup-layer").fadeOut(),$("#"+e.name).prop("checked",!0),newFeatures(e.name),$('input[type = "radio"][name = "layer"][value = '+e.name+"]").click()}function importNewLayerType(e){$("#getGeojson").append("<div><input type='checkbox' id="+e.name+" refs='"+e.type+"' name='layerObj'><input type='radio' value = "+e.name+" layerType = "+e.type+" name='layer'><span class='layer-name'>"+e.name+"</span><img src='./img/igis_opt_stop.png' class='deleteFeature' name="+e.name+" type="+e.type+"></div>"),$("#glassLayer,.popup-layer").fadeOut(),$("#"+e.name).prop("checked",!0),$('input[type = "radio"][name = "layer"][value = '+e.name+"]").click()}function feature_select(e){markerTips.setPosition(void 0),switchStatus("modify"),switchStatus("berth"),modifyObj&&modifyObj.removeInteraction(),editObj.removeEdit();var t={isScale:!0,isRotate:!0,isStretch:!0,isTranslate:!0,isTranslateFeature:!1,layerObj:currLayerObj};editObj.addEdit(t,dataConversion)}function stop_select(){editObj.removeEdit()}function modify_select(){markerTips.setPosition(void 0),switchStatus("telescopic"),editObj&&editObj.removeEdit(),modifyObj.addTranslateAndModify({interactionType:"modify",layerObj:currLayerObj},dataConversion)}function stop_modify(){modifyObj.removeInteraction()}function selectPop(e,t){selPopupType=null,markerTips.setPosition(t),e.getProperties().currOperateFeatures!=currLayerId||"all"==sel_type?$("#fun4, #fun5, #fun6, #fun7").hide():$("#fun4, #fun5, #fun6, #fun7").show();var r=e.getProperties();r.cp=t,r.height?r.height=r.height:r.height="";var a='<input type="hidden" value="'+e.getId()+'" />';for(var o in r){"geometry"!=o&&"cp"!=o&&"display"!=o&&"property"!=o&&("Polygon"==e.getGeometry().getType()||"MultiPolygon"==e.getGeometry().getType()?a+="bgType"==o?"<li><input type='text' value='"+o+"' class='attr-label'><select class='attr-value'><option value='color' selected>color</option><option value='img'>img</option></select></li>":"fillColor"==o?"<li class='poly-fillColor'><input type='text' value='"+o+"' class='attr-label'><input type='text' value='"+r[o]+"' name='showAlpha' id='showAlpha' class='attr-value'></li>":"src"==o?"<li class='poly-src'><input type='text' value='"+o+"' class='attr-label'><input type='text' value='"+r[o]+"' class='attr-value new-show-img'></li>":"currOperateFeatures"==o?"<li><input type='text' value='"+o+"' class='attr-label' readonly><input type='text' value='"+r[o]+"' class='attr-value' readonly></li>":"<li><input type='text' value='"+o+"' class='attr-label'><input type='text' value='"+r[o]+"' class='attr-value'></li>":"LineString"==e.getGeometry().getType()||"MultiLineString"==e.getGeometry().getType()?a+="currOperateFeatures"==o?"<li class='poly-fillColor'><input type='text' value='"+o+"' class='attr-label' readonly><input type='text' value='"+r[o]+"' class='attr-value' readonly></li>":"igis_id"==o||"fclass"==o?"<li><input type='text' value='"+o+"' class='attr-label' readonly><input type='text' value='"+r[o]+"' class='attr-value' readonly></li>":"<li><input type='text' value='"+o+"' class='attr-label'><input type='text' value='"+r[o]+"' class='attr-value'></li>":"Point"!=e.getGeometry().getType()&&"MultiPoint"!=e.getGeometry().getType()||(a+="icon"==o?"<li><input type='text' value='"+o+"' class='attr-label'><input type='text' value='"+r[o]+"' class='attr-value new-point-icon'></li>":"currOperateFeatures"==o?"<li><input type='text' value='"+o+"' class='attr-label' readonly><input type='text' value='"+r[o]+"' class='attr-value' readonly></li>":"<li><input type='text' value='"+o+"' class='attr-label'><input type='text' value='"+r[o]+"' class='attr-value'></li>"))}document.getElementById("longitude").innerHTML=a,r.src?($("#longitude select.attr-value").val("img"),$(".poly-src").show().siblings(".poly-fillColor").hide()):($("#longitude select.attr-value").val("color"),$(".poly-fillColor").show().siblings(".poly-src").hide()),$("#showAlpha").spectrum({preferredFormat:"rgb",showInput:!0,showAlpha:!0,showPalette:!0,palette:[["red","rgba(0, 0, 0, 0)","rgb(255, 255, 255)"]]})}function selectPopNewAdd(e,t){selPopupType=e,markerTips.setPosition(t),"all"==sel_type?$("#fun4,#fun5,#fun6,#fun7").hide():$("#fun4,#fun5,#fun6,#fun7").show();var r=e.properties;r.cp=t,r.height?r.height=r.height:r.height="";var a='<input type="hidden" value="'+e.id+'" />';for(var o in r){"geometry"!=o&&"cp"!=o&&"display"!=o&&"property"!=o&&("Polygon"==e.geometry.type?a+="bgType"==o?"<li><input type='text' value='"+o+"' class='attr-label'><select class='attr-value'><option value='color' selected>color</option><option value='img'>img</option></select></li>":"currOperateFeatures"==o?"<li class='poly-fillColor'><input type='text' value='"+o+"' class='attr-label' readonly><input type='text' value='"+r[o]+"' class='attr-value' readonly></li>":"fillColor"==o?"<li class='poly-fillColor'><input type='text' value='"+o+"' class='attr-label'><input type='text' value='"+r[o]+"' name='showAlpha' id='showAlpha' class='attr-value'></li>":"src"==o?"<li class='poly-src'><input type='text' value='"+o+"' class='attr-label'><input type='text' value='"+r[o]+"' class='attr-value new-show-img'></li>":"<li><input type='text' value='"+o+"' class='attr-label'><input type='text' value='"+r[o]+"' class='attr-value'></li>":"LineString"==e.geometry.type?a+="currOperateFeatures"==o?"<li class='poly-fillColor'><input type='text' value='"+o+"' class='attr-label' readonly><input type='text' value='"+r[o]+"' class='attr-value' readonly></li>":"igis_id"==o||"fclass"==o?"<li><input type='text' value='"+o+"' class='attr-label' readonly><input type='text' value='"+r[o]+"' class='attr-value' readonly></li>":"<li><input type='text' value='"+o+"' class='attr-label'><input type='text' value='"+r[o]+"' class='attr-value'></li>":"Point"==e.geometry.type&&(a+="icon"==o?"<li><input type='text' value='"+o+"' class='attr-label'><input type='text' value='"+r[o]+"' class='attr-value new-point-icon'></li>":"currOperateFeatures"==o?"<li class='poly-fillColor'><input type='text' value='"+o+"' class='attr-label' readonly><input type='text' value='"+r[o]+"' class='attr-value' readonly></li>":"<li><input type='text' value='"+o+"' class='attr-label'><input type='text' value='"+r[o]+"' class='attr-value'></li>"))}document.getElementById("longitude").innerHTML=a,r.src?($("#longitude select.attr-value").val("img"),$(".poly-src").show().siblings(".poly-fillColor").hide()):($("#longitude select.attr-value").val("color"),$(".poly-fillColor").show().siblings(".poly-src").hide()),$("#showAlpha").spectrum({preferredFormat:"rgb",showInput:!0,showAlpha:!0,showPalette:!0,palette:[["red","rgba(0, 0, 0, 0)","rgb(255, 255, 255)"]]})}function pop_close(){document.getElementById("marker").style.display="none"}function assemble(e){return e.features.map(function(e){var t=[],r=e.geometry.coordinates;1<r.length&&3<=num(r)?2<num(r=r.reduce(function(e,t){return e.concat(t)},[]))&&(r=r.reduce(function(e,t){return e.concat(t)},[])):r=r.reduce(function(e,t){return e.concat(t)},[]),t.push(r),e.geometry.coordinates.splice.apply(e.geometry.coordinates,[0,e.geometry.coordinates.length].concat(t))}),console.info("geojson封装：",e),e}function dataConversion(e){var t=e.getGeometry().getCoordinates();if("all"==sel_type){if("MultiPoint"==e.getGeometry().getType()){var r=[];t.map(function(e){r.push(mymap.reTransform(e,!1))}),layerJsonData[currLayerId].features[0].geometry.coordinates=r}else"MultiLineString"==e.getGeometry().getType()?t.map(function(e,t){var r=[];e.map(function(e){r.push(mymap.reTransform(e,!1))}),layerJsonData[currLayerId].features[0].geometry.coordinates[t]=[r]}):"MultiPolygon"==e.getGeometry().getType()&&t.map(function(e,t){if(layerJsonData[currLayerId].features[0].geometry){var r=[];e[0].map(function(e){r.push(mymap.reTransform(e,!1))}),layerJsonData[currLayerId].features[0].geometry.coordinates[t]=[r]}else{layerJsonData[currLayerId].features[0]=e;var a=layerJsonData[currLayerId].features[0][0];r=[];a.map(function(e){r.push(mymap.reTransform(e,!1))}),layerJsonData[currLayerId].features[0]=r}});console.info("整体组装：",layerJsonData[currLayerId])}else{if("Point"==e.getGeometry().getType()){var a=e.id_;layerJsonData[currLayerId].features.map(function(e){e.id==a&&(e.geometry.coordinates=mymap.reTransform(t,!1))})}else if("LineString"==e.getGeometry().getType()){a=e.id_,r=[];t.map(function(e){r.push(mymap.reTransform(e,!1))}),layerJsonData[currLayerId].features.map(function(e){e.id==a&&(e.geometry.coordinates=r)})}else{a=e.id_,r=[];t[0].map(function(e){r.push(mymap.reTransform(e,!1))}),layerJsonData[currLayerId].features.map(function(e){e.id==a&&(e.geometry.coordinates=[r])})}console.info("零件组装：",layerJsonData[currLayerId])}}function all_layer(){var t=[];tmpPartJsonData=layerJsonData[currLayerId],layerJsonData[currLayerId].features.map(function(e){e.geometry?t.push(e.geometry.coordinates):t.push(e)});var e="";"point"==$("#"+currLayerId).attr("refs")?e="MultiPoint":"line"==$("#"+currLayerId).attr("refs")?e="MultiLineString":"polygon"==$("#"+currLayerId).attr("refs")&&(e="MultiPolygon"),geojsonObject.features[0].geometry.type=e,geojsonObject.features[0].geometry.coordinates=t,geojsonObject.geoType="MultiPolygon"==e?"polygon":"MultiLineString"==e?"line":"MultiPoint"==e?"point":"polygon",layerJsonData[currLayerId]=geojsonObject}function part_layer(){tmpPartJsonData.features.map(function(e,t){"LineString"==e.geometry.type?2==num(layerJsonData[currLayerId].features[0].geometry.coordinates[t])?e.geometry.coordinates=layerJsonData[currLayerId].features[0].geometry.coordinates[t]:3==num(layerJsonData[currLayerId].features[0].geometry.coordinates[t])&&(e.geometry.coordinates=layerJsonData[currLayerId].features[0].geometry.coordinates[t][0]):"Point"==e.geometry.type?e.geometry.coordinates=layerJsonData[currLayerId].features[0].geometry.coordinates[t]:"Polygon"==e.geometry.type&&(e.geometry.coordinates=layerJsonData[currLayerId].features[0].geometry.coordinates[t])}),layerJsonData[currLayerId]=tmpPartJsonData,tmpPartJsonData={}}function changeLayer(e){sel_type=e,markerTips.setPosition(void 0),switchStatus("telescopic"),switchStatus("modify"),switchStatus("berth"),editObj&&editObj.removeEdit(),modifyObj&&modifyObj.removeInteraction(),(drawObj||shapeObj)&&offAttr(),"all"==sel_type?(all_layer(),$(".modify,#addFea,#fun9>p").slideUp("fast")):"part"==sel_type&&(part_layer(),$(".modify,#addFea,#fun9>p").slideDown("fast")),mymap.removeLayer(layerObj[currLayerId]),newFeatures(currLayerId)}function switchStatus(e,t){$("#"+e).attr("class","switch-off"),$(".switch-off").css({"border-color":"#dfdfdf","box-shadow":"rgb(223, 223, 223) 0px 0px 0px 0px inset","background-color":"rgb(255, 255, 255)"}),"telescopic"==e?editObj&&editObj.removeEdit():"modify"==e?modifyObj&&modifyObj.removeInteraction():"berth"==e&&(berthState=!1)}function addAttr(){for(var e=!1,t=0;t<$("#longitude li").length;t++){var r=$($("#longitude li")[t]).children(".attr-label").val(),a=$($("#longitude li")[t]).children(".attr-value").val();if(!r&&!a){console.log("填写完整属性后再添加……"),e=!0;break}e=!1}e||$("#longitude").append("<li><input type='text' value='' class='attr-label'><input type='text' value='' class='attr-value'></li>")}function offAttr(){markerTips.setPosition(void 0),isClick=!0,drawObj&&drawObj.removeDrawFeature(),shapeObj&&shapeObj.removeCreate(),$("#fun8").hide(),$(".igis_btn_list").removeClass("cover_layer"),$("#batchAddFeature").html('<img src="img/igis_fea_batch.png" title="批量添加">批量添加')}function startDraw(a){if(popup())return!1;drawObj.removeDrawFeature(),shapeObj.removeCreate(),isClick=!1,drawObj.addDrawFeature(a,function(e){var t=[0,0],r={type:"Feature",id:(new Date).getTime().toString(),properties:{name:"new",height:"",currOperateFeatures:currLayerId},geometry:{type:"Square"==a?"Polygon":a,coordinates:e}};"Point"==a?t=e:"LineString"==a?(t=e[0],r.properties.igis_id=r.id,r.properties.fclass="unclassified"):"Polygon"!=a&&"Square"!=a||(t=e[0][0],r.properties.cp=e[0][0],r.properties.bgType="",r.properties.fillColor="rgba(0,102,255,0.5)",r.properties.src=""),popupSaveData=r.properties,selectPopNewAdd(r,t)}),drawObj.setSnapObjLayer(currLayerObj)}function add_shape(e){if(popup())return!1;drawObj.removeDrawFeature(),shapeObj.removeCreate(),isClick=!1,shapeObj.addCreate(e,function(e){var t=(e=e.getGeometry().getCoordinates()[0].map(function(e){return mymap.reTransform(e,!1)}))[0],r={type:"Feature",id:(new Date).getTime().toString(),properties:{name:"new",height:"",currOperateFeatures:currLayerId},geometry:{type:"Polygon",coordinates:[e]}};r.properties.cp=t,r.properties.bgType="",r.properties.fillColor="rgba(0,102,255,0.5)",r.properties.src="",popupSaveData=r.properties,selectPopNewAdd(r,t)})}function add_newIcon(e){if(popup())return!1;drawObj.removeDrawFeature(),shapeObj.removeCreate(),isClick=!1,drawObj.addDrawFeature(e,function(e){var t=e,r={type:"Feature",id:(new Date).getTime().toString(),properties:{name:"newIcom",height:"",icon:"",display:zoomRange,currOperateFeatures:currLayerId},geometry:{type:"Point",coordinates:e}};r.properties.property=iconSaveData,r.properties.property.label=r.properties.property.name=r.properties.name,r.properties.property.src=r.properties.icon,popupSaveData=r.properties,selectPopNewAdd(r,t)})}function multiFeature(l,r,n){var s=[];return l.map(function(a,o){if(a.id||(a.id=o),"polygon"==r){if("Polygon"==a.geometry.type)setCenter=a.geometry.coordinates[0][0];else if("MultiPolygon"==a.geometry.type)if(setCenter=a.geometry.coordinates[0][0][0],1==a.geometry.coordinates.length)a.geometry.coordinates=a.geometry.coordinates[0];else if(1<a.geometry.coordinates.length){var e=JSON.parse(JSON.stringify(a.geometry.coordinates));l.splice(o,1),e.map(function(e,t){var r=JSON.parse(JSON.stringify(a));r.id=r.id+""+t,r.geometry.coordinates=e,r.properties.currOperateFeatures=n,r.geometry.type="Polygon",0<t?s.push(r):l.splice(o+t,0,r)})}a.properties.currOperateFeatures=n,a.geometry.type="Polygon"}else if("line"==r){if("LineString"==a.geometry.type)setCenter=a.geometry.coordinates[0];else if("MultiLineString"==a.geometry.type)if(setCenter=a.geometry.coordinates[0][0],1==a.geometry.coordinates.length)a.geometry.coordinates=a.geometry.coordinates[0];else if(1<a.geometry.coordinates.length){e=JSON.parse(JSON.stringify(a.geometry.coordinates));l.splice(o,1),e.map(function(e,t){var r=JSON.parse(JSON.stringify(a));r.id=r.id+""+t,r.geometry.coordinates=e,r.properties.currOperateFeatures=n,r.geometry.type="LineString",r.properties.igis_id=r.id,0<t?s.push(r):l.splice(o+t,0,r)})}a.properties.currOperateFeatures=n,a.geometry.type="LineString"}else if("point"==r){if(setCenter=a.geometry.coordinates,a.properties.icon&&(a.properties.property={isBox:!0,label:a.properties.name,src:pathUrl+a.properties.icon,scale:.4,anchor:[31,31],labOffsetY:18,labFillColor:"#D9F0FF",labStrokeColor:"#243142",labStrokeWidth:2,selFillColor:"#ACD1F3",selLabFillColor:"#D9F0FF",selLabStrokeColor:"#243142",selLabStrokeWidth:2}),"[object Array]"!=Object.prototype.toString.call(a.properties.display)&&a.properties.display){var t=[];a.properties.display.split(",").forEach(function(e){t.push(Number(i))}),a.properties.display=t}a.properties.currOperateFeatures=n,a.geometry.type="Point"}}),l.concat(s)}iconSaveData={isBox:!0,label:"label",src:"",scale:.4,anchor:[31,31],labOffsetY:18,labFillColor:"#D9F0FF",labStrokeColor:"#243142",labStrokeWidth:2,selFillColor:"#ACD1F3",selLabFillColor:"#D9F0FF",selLabStrokeColor:"#243142",selLabStrokeWidth:2},mymap.addCustomClickEvent(function(e){}),$(function(){var e=!1;$("#batchAddFeature").on("click",function(){if(markerTips.setPosition(void 0),$("#fun4, #fun6, #fun8").show(),popup())return!1;e?batchFeature():(batchAddFeature=[],$(".igis_btn_list").addClass("cover_layer"),$(this).html('<img src="img/igis_fea_batch.png" title="批量添加">停止添加'),isClick=!1,"point"==currLayerType?startDrawFeature("Point"):"line"==currLayerType?startDrawFeature("LineString"):"polygon"==currLayerType&&startDrawFeature("Polygon")),e=!e}),$("#fun8").on("click",function(){for(var r={},e=0;e<$("#longitude li").length;e++){var t=$($("#longitude li")[e]).children(".attr-label").val(),a=$($("#longitude li")[e]).children(".attr-value").val();(t||a)&&t&&(r[t]=a)}r.hasOwnProperty("icon")&&"point"==currLayerType&&r.icon&&(r.property=iconSaveData,r.property.label=r.name,r.property.src=pathUrl+r.icon,r.display=zoomRange);batchAddFeature.forEach(function(e,t){e.properties=$.extend(!0,e.properties,r)}),$(".igis_btn_list").removeClass("cover_layer"),$("#batchAddFeature").html('<img src="img/igis_fea_batch.png" title="批量添加">批量添加'),isClick=!0,layerJsonData[currLayerId].features=layerJsonData[currLayerId].features.concat(batchAddFeature),mymap.removeLayer(layerObj[currLayerId]),newFeatures(currLayerId),drawObj.removeDrawFeature(),editObj&&(editObj.removeEdit(),switchStatus("telescopic"),switchStatus("modify"),switchStatus("berth")),markerTips.setPosition(void 0),$("#fun8").hide()})}),$(function(){var e=!1;$(".igis_takeup").click(function(){e=e?($(".igis_btn_list").slideDown(),$(this).removeClass("trans"),!1):($(".igis_btn_list").slideUp(),$(this).addClass("trans"),!0)}),$("#openNewLayer").on("change",function(){var a=this.files[0],e=new FileReader;e.readAsText(a),e.onload=function(){var e=a.name.split(".")[0],t=JSON.parse(this.result).geoType;t?"Polygon"==t?t="polygon":"LineString"==t?t="line":"Point"==t&&(t="point"):"MultiPolygon"==(t=JSON.parse(this.result).features[0].geometry.type)?t="polygon":"MultiLineString"==t?t="line":"MultiPoint"==t?t="point":"Polygon"==t?t="polygon":"LineString"==t?t="line":"Point"==t&&(t="point");var r=JSON.parse(this.result);r.features=multiFeature(r.features,t,e),currLayerId=e,mymap.setMapCenter(setCenter),currLayerType=t,r.srid="4326",r.geoType=t,r.fieldsInfo?r.fieldsInfo:r.fieldsInfo=[],layerJsonData[e]=r,newFeatures(e),importNewLayerType({name:e,type:t})}}),$("#saveLayerType").on("click",function(){var e=$("#layerName").val(),t=$("#layerType").val();if(!e)return!1;saveLayerType({name:e,type:t})}),$("#saveService").on("click",function(){var e=$("#serviceUrl").val();if(!e)return!1;$("#mapCenter").val()&&$("#mapCenter").val();var t=JSON.parse($("#mapCenter").val()),r="[object Array]"==Object.prototype.toString.call(t);t&&r||(t=setCenter),$("#closeService").click(),changeMapService(e,t)}),$("#getGeojson").on("click",'input[type="checkbox"]',function(){for(var e=$(this).attr("id"),t=0;t<$("#getGeojson > div").length;t++){var r=$($($("#getGeojson > div")[t]).children("input")[0]).prop("checked"),a=$($($("#getGeojson > div")[t]).children("input")[1]).prop("checked");if(r&&a){$("#select_type_box2").fadeIn();break}$("#select_type_box2").fadeOut()}1==$(this).prop("checked")?newFeatures(e):mymap.removeLayer(layerObj[e])}),$("#getGeojson").on("click",'input[type = "radio"][name="layer"]',function(){currLayerObj=layerObj[$(this).val()],currLayerId=$(this).val(),currLayerType=$(this).attr("layerType"),$("#addFea > img").hide(),"polygon"==$(this).attr("layerType")?$("#addFea > img.plane").show():"line"==$(this).attr("layerType")?$("#addFea > img.lines").show():$("#addFea > img.dot").show(),$("#"+currLayerId).prop("checked")||($("#"+currLayerId).prop("checked",!0),newFeatures(currLayerId)),$("#select_type_box2").fadeIn(),switchStatus("telescopic"),switchStatus("modify"),switchStatus("berth"),berthState=!1,drawObj&&drawObj.removeDrawFeature(),isClick=!0,shapeObj&&shapeObj.removeCreate(),isClick=!0,drawObj=new iGis.maptools.DrawFeature({gisMapObj:mymap,isSnap:berthState,snapLayer:currLayerObj})}),$("#getGeojson").on("click",".deleteFeature",function(){var e=$(this).attr("name");$(this).attr("type");Object.keys(layerObj).length&&mymap.removeLayer(layerObj[e]),delete layerJsonData[e],$(this).parent().remove()}),$('input[type = "radio"][name="layerSel"]').on("click",function(){changeLayer($(this).val())}),$("#pop-close, #fun4").on("click",function(){offAttr()}),$("#fun5").on("click",function(){mymap.removeLayer(layerObj[currLayerId]);for(var t=$(this).parent().find('input[type="hidden"]').val(),r={},e=0;e<$("#longitude li").length;e++){var a=$($("#longitude li")[e]).children(".attr-label").val(),o=$($("#longitude li")[e]).children(".attr-value").val();(a||o)&&a&&(r[a]=o)}r.hasOwnProperty("icon")&&"point"==currLayerType&&r.icon&&(r.property={isBox:!0,label:r.name,src:pathUrl+r.icon,scale:.4,anchor:[31,31],labOffsetY:18,labFillColor:"#D9F0FF",labStrokeColor:"#243142",labStrokeWidth:2,selFillColor:"#ACD1F3",selLabFillColor:"#D9F0FF",selLabStrokeColor:"#243142",selLabStrokeWidth:2},r.display=zoomRange),"part"!=sel_type||selPopupType?"all"!=sel_type||selPopupType?selPopupType&&($.each(r,function(e,t){var r=!1;if(layerJsonData[currLayerId].fieldsInfo||(layerJsonData[currLayerId].fieldsInfo=[],layerJsonData[currLayerId].srid="4326",layerJsonData[currLayerId].geoType=currLayerType),layerJsonData[currLayerId].fieldsInfo.length){for(var a=0;a<layerJsonData[currLayerId].fieldsInfo.length;a++){if(layerJsonData[currLayerId].fieldsInfo[a].fieldName==e){r=!1;break}r=!0}r&&layerJsonData[currLayerId].fieldsInfo.push({fieldName:e,fieldType:t?isNaN(t)?"String":"double":"String"})}else layerJsonData[currLayerId].fieldsInfo.push({fieldName:e,fieldType:t?isNaN(t)?"String":"double":"String"})}),layerJsonData[currLayerId].features.push(selPopupType),layerJsonData[currLayerId].features.forEach(function(e){e.id==t&&(e.properties=r)}),console.info("新添零件属性：",layerJsonData[currLayerId])):(geojsonObject.features[0].properties=r,console.info("保存整体属性：",layerJsonData[currLayerId])):(layerJsonData[currLayerId].features.forEach(function(e){e.id==t&&(e.properties=r)}),console.info("保存零件属性：",layerJsonData[currLayerId])),newFeatures(currLayerId),editObj&&(editObj.removeEdit(),switchStatus("telescopic"),switchStatus("modify")),offAttr()}),$("#fun6").on("click",function(){addAttr()}),$("#fun7").on("click",function(){var t=$(this).parent().find('input[type="hidden"]').val();offAttr(),currLayerObj.removeFeatureById(t),layerJsonData[currLayerId].features.splice(layerJsonData[currLayerId].features.findIndex(function(e){return e.id==t}),1)}),$("#addFea img").on("click",function(){if(markerTips.setPosition(void 0),"addpoint"==$(this).attr("id")){add_newIcon("Point")}else if("addline"==$(this).attr("id")){startDraw("LineString")}else if("addpolygon"==$(this).attr("id")){startDraw("Square")}else if("addCircle"==$(this).attr("id")){add_shape({sides:0})}else if("addThree"==$(this).attr("id")){add_shape({sides:3})}else if("addFive"==$(this).attr("id")){add_shape({sides:5})}else if("addSix"==$(this).attr("id")){add_shape({sides:6})}else if("addSeven"==$(this).attr("id")){add_shape({sides:7})}else if("addsquare"==$(this).attr("id")){startDraw("Polygon")}}),$("#saveFea").on("click",function(){if(popup())return!1;var e=JSON.stringify(layerJsonData[currLayerId]),t=new Blob([e],{type:""});saveAs(t,currLayerId+".geojson")}),$("#changeMap").on("click",function(){$("#changeService,.popup-layer").fadeIn()}),$("#addNewLayer").on("click",function(){$("#glassLayer,.popup-layer").fadeIn()}),$("#closeLayerType,#markerImg-close,#closeService").on("click",function(){$("#glassLayer,#markerImg,#changeService,.popup-layer").fadeOut()}),$("#longitude").on("click",".new-show-img, .new-point-icon",function(){$(".markerImg-center").html("");var e=$(this)[0].classList[1],t="";"new-point-icon"==e?t="iconImage":"new-show-img"==e&&(t="polygonImage"),$.getJSON("json/"+t+".json",function(e){e.forEach(function(e,t){$(".markerImg-center").append('<img src="'+pathUrl+e.img+'">')})}),$("#markerImg,.popup-layer").fadeIn()}),$("#longitude").on("change","li select.attr-value",function(){"color"==$("#longitude select.attr-value").val()?($(".poly-src").hide(),$(".poly-fillColor").show()):($(".poly-fillColor").hide(),$(".poly-src").show())}),$("#markerImg").on("click",".markerImg-center > img",function(){var e=$(this).attr("src");$("#longitude .new-show-img").val(e.substr(e.indexOf("/image/safePark/bgImg/"))),$("#longitude .new-point-icon").val(e.substr(e.indexOf("/image/safePark/icon/"))),$("#markerImg,.popup-layer").fadeOut()}),$("#editSubmit").on("click",function(){var e=[],t=$("#editLongitude").val(),r=$("#editLatitude").val();if(t&&r)e[0]=JSON.parse(t),e[1]=JSON.parse(r);else if(popup("请输入经纬度后重新确定！"))return!1;console.log(e),mymap.setMapCenter(e)}),switchEvent("#telescopic",function(){if(popup())return switchStatus("telescopic"),!1;feature_select($('input[type = "radio"][name="layerSel"]:checked').val())},function(){if(popup())return!1;stop_select()}),switchEvent("#modify",function(){if(popup())return switchStatus("modify"),!1;isClick=!1,modify_select()},function(){if(popup())return!1;isClick=!0,stop_modify()}),switchEvent("#berth",function(){if(offAttr(),popup())return switchStatus("berth"),!1;berthState=!0,drawObj=new iGis.maptools.DrawFeature({gisMapObj:mymap,isSnap:berthState,snapLayer:currLayerObj})},function(){if(offAttr(),popup())return!1;berthState=!1,drawObj=new iGis.maptools.DrawFeature({gisMapObj:mymap,isSnap:berthState,snapLayer:currLayerObj})})});